<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>A Million Dillions</title>
    <style>
      .canvas {
        background-color: white;
        display: flex;
        flex-wrap: wrap;
        margin-bottom: 2rem;
      }
      .pixel {
        box-sizing: border-box;
        width: 20px;
        height: 20px;
        border: solid 1px #ccc;
      }
      .pixel.ink {
        background-color: black;
      }
      #bitmap {
        width: 16px;
        height: 16px;
      }
      .selfies {
        background: white;
        width: 320px;
      }
      .selfie {
        display: block;
        margin: 2rem auto;
      }
    </style>
  </head>
  <body ondragstart="return false;" ondrop="return false;">
    <div class="canvas"></div>
    <button id="clear">Clear</button>
    <div class="selfies"></div>
    <canvas id="bitmap" width="16" height="16"></canvas>
    <script>
      (async function () {
        "use strict";

        const pixelCount = 16;

        const pixels = Array(pixelCount)
          .fill(0)
          .map(() => Array(pixelCount).fill(0));
        const fragment = document.createDocumentFragment();

        let draggingState = 1;

        for (const row of pixels) {
          for (const pixel of row) {
            const div = document.createElement("div");
            div.className = "pixel";
            div.addEventListener("mousedown", ({ target }) => {
              draggingState = !target.classList.contains("ink");
              target.classList.toggle("ink", !!draggingState);
            });
            div.addEventListener("mouseover", function (ev) {
              if (1 === ev.buttons) {
                ev.target.classList.toggle("ink", !!draggingState);
              }
            });
            fragment.appendChild(div);
          }
        }

        document.getElementById("clear").addEventListener("click", () => {
          Array.from(document.querySelectorAll(".pixel.ink")).forEach((e) => e.classList.remove("ink"));
        });

        const { ink, paper } = window.location.search
          .replace(/^\?/, "")
          .split("&")
          .reduce((o, c) => ({ ...o, [c.split("=")[0]]: c.split("=")[1] }), {
            ink: "black",
            paper: "white",
          });

        const canvas = document.querySelector(".canvas");
        canvas.style.width = `${pixelCount * 20}px`;
        canvas.style.backgroundColor = paper;
        canvas.appendChild(fragment);

        if ("black" !== ink) {
          const ss = document.createElement("style");
          ss.innerHTML = `.pixel.ink { background-color: ${ink}; }`;
          document.head.appendChild(ss);
        }

        const bitmap = document.querySelector("#bitmap");
        const scale = 4;
        const bitmapSize = pixelCount * scale;
        bitmap.width = bitmap.height = bitmapSize;
        bitmap.style.width = bitmap.style.height = `${bitmapSize}px`;

        const ctx = bitmap.getContext("2d");

        function getImageUrl(code) {
          const rows = code.split(",").map((n) => parseInt(n, 16).toString(2).padStart(16, "0"));

          ctx.fillStyle = paper;
          ctx.fillRect(0, 0, bitmapSize, bitmapSize);
          ctx.fillStyle = ink;

          rows.forEach((row, y) => {
            row.split("").forEach((fill, x) => {
              if (0 < fill) {
                ctx.fillRect(x * scale, y * scale, scale, scale);
              }
            });
          });

          const url = bitmap.toDataURL("image/png");
          return url;
        }

        let backgroundUpdate = false;
        const selfies = document.querySelector(".selfies");

        function addPortrait([pixels, label]) {
          const img = new Image(bitmapSize, bitmapSize);
          img.className = "selfie";
          img.title = label;
          img.src = getImageUrl(pixels);
          if (!backgroundUpdate) {
            backgroundUpdate = true;
            document.body.style.backgroundImage = `url(${img.src})`;
            const setFavicon = document.createElement("link");
            setFavicon.setAttribute("rel", "shortcut icon");
            setFavicon.setAttribute("href", img.src);
            document.querySelector("head").appendChild(setFavicon);
          }
          selfies.appendChild(img);
        }

        const portraits = [
          ["2,ff4,3ffc,7ffe,7ffe,6006,6006,6002,8e71,8211,4002,2084,2104,21c4,2004,1088", "2021/09/03"],
          ["3ff8,79c9,6008,6005,4f7c,4215,2044,a049,a0ca,3009,99aa,4c49,261a,53f1,a802,5401", "2021/09/02"],
          ["07E4,0FF8,1FF8,1FFC,181C,1004,1774,3226,3006,1144,1084,1004,1364,0888,0410,03E0", "2021/08/31"],
        ];

        portraits.forEach(addPortrait);
      })();
    </script>
  </body>
</html>
